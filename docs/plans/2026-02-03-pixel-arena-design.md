# Pixel Arena - 在线多人竞技像素游戏设计文档

> 创建日期: 2026-02-03

## 📋 项目概述

| 维度 | 描述 |
|------|------|
| 游戏类型 | 实时 PvP 对战 |
| 战斗机制 | 俯视角射击（双摇杆风格） |
| 对战规模 | 4-8 人混战，淘汰制 |
| 平台 | 网页端浏览器 |
| 角色系统 | 多角色基础技能 + 道具解锁额外技能 |
| 游戏节奏 | 3-5 分钟/局，缩圈机制 |
| 商业模式 | 完全免费（个人项目） |
| 账号系统 | 简单昵称 + 本地存储战绩 |
| 技术栈 | Phaser 3 + Colyseus + Node.js |

---

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      客户端 (浏览器)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │  Phaser 3   │  │  游戏逻辑   │  │  Colyseus SDK   │  │
│  │  渲染引擎   │  │  输入处理   │  │  状态同步       │  │
│  └─────────────┘  └─────────────┘  └─────────────────┘  │
└───────────────────────────┬─────────────────────────────┘
                            │ WebSocket
┌───────────────────────────▼─────────────────────────────┐
│                   Colyseus 服务器                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  房间管理    │  │  游戏状态    │  │  物理/碰撞   │   │
│  │  匹配系统    │  │  权威计算    │  │  伤害判定    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────┘
```

**核心原则**：
- **服务端权威** - 所有伤害判定、位置验证由服务器决定，防作弊
- **客户端预测** - 本地先渲染移动，服务器校正，减少延迟感
- **状态同步** - Colyseus 自动处理房间内玩家状态广播

---

## 🚪 房间与匹配流程

```
玩家进入游戏
      │
      ▼
┌─────────────┐    无可用房间    ┌─────────────┐
│  输入昵称   │ ───────────────▶ │  创建新房间  │
│  选择角色   │                  │  等待玩家   │
└──────┬──────┘                  └──────┬──────┘
       │ 有可用房间                      │
       ▼                                │
┌─────────────┐                         │
│  加入房间   │ ◀───────────────────────┘
│  等待开始   │
└──────┬──────┘
       │ 人数达到 4-8 人 或 等待超时
       ▼
┌─────────────┐
│  游戏开始   │
│  倒计时 3s  │
└─────────────┘
```

**房间状态**：

| 状态 | 说明 |
|------|------|
| `waiting` | 等待玩家加入，显示当前人数 |
| `starting` | 人数足够，3 秒倒计时 |
| `playing` | 游戏进行中，不可加入 |
| `ended` | 游戏结束，显示排名，10 秒后销毁 |

**匹配规则**：
- 最少 4 人开始，最多 8 人
- 等待 30 秒后，若 ≥4 人则强制开始
- 游戏中房间锁定，新玩家进入新房间

---

## 🎮 角色与技能系统

### 基础角色（首发 4 个）

| 角色 | 定位 | 基础技能 | 被动特性 |
|------|------|----------|----------|
| 🔫 突击兵 | 均衡输出 | 冲刺翻滚（短距离闪避） | 移速 +5% |
| 🛡️ 重装 | 肉盾 | 举盾格挡（正面减伤 50%） | 生命值 +30%，移速 -10% |
| 🏹 游侠 | 远程 | 后跳射击（跳跃同时射击） | 射程 +20% |
| 💊 医疗兵 | 辅助 | 治疗光环（范围回血） | 自动缓慢回血 |

### 道具解锁技能（地图随机刷新）

| 道具图标 | 解锁技能 | 效果 | 持续/次数 |
|----------|----------|------|-----------|
| 🔥 | 燃烧弹 | 投掷火焰区域，持续伤害 | 2 次使用 |
| ⚡ | 闪电链 | 攻击自动弹射到附近敌人 | 15 秒 |
| 🧲 | 磁力护盾 | 吸收一次伤害 | 1 次 |
| 👻 | 隐身药水 | 短暂隐身，攻击后解除 | 5 秒 |
| 🚀 | 加速靴 | 移速翻倍 | 8 秒 |

**技能槽位规则**：
- 每个玩家 1 个基础技能（角色自带）+ 1 个道具技能槽
- 捡到新道具会替换旧的道具技能
- 基础技能 CD 较短（5秒），道具技能用完即消失

---

## 🗺️ 地图与缩圈机制

### 地图设计

```
┌──────────────────────────────────────────────────────────────┐
│  🌊🌊🌊      ▓▓▓▓▓      🎁       🏠🏠🏠       ▓▓▓▓      🌲🌲 │
│  🌊🌊🌊  💣  ▓▓▓▓▓   ░░░░░    🚪🏠🏠🏠🚪      ▓▓▓▓  🎁  🌲🌲 │
│  🌊🌊       ═══════  ░░░░░       🏠🏠🏠              🌲🌲🌲 │
│        🎁    桥梁         🎁              ░░░    💣     🌲🌲 │
│  🏭🏭🏭    ═══════              ▓▓▓▓▓▓    ░░░          🌿🌿 │
│  🏭⚙️🏭        💣      🌿🌿🌿   ▓▓▓▓▓▓    ░░░    🎁    🌿🌿 │
│  🏭🏭🏭   ░░░        🌿🌿🌿🌿         ════════════    🌿🌿 │
│           ░░░    🎁  🌿🌿🌿🌿    💣       传送带       ▓▓▓ │
│     🚗    ░░░              🌿🌿       ════════════    ▓▓▓ │
│  ═══════════      ▓▓▓▓             🎁          🔥🔥   ▓▓▓ │
│     铁轨    💣    ▓▓▓▓    🏠🏠        ░░░░     🔥🔥🔥      │
│  ═══════════      ▓▓▓▓    🏠🏠   🎁   ░░░░  💣 🔥🔥🔥  🎁  │
└──────────────────────────────────────────────────────────────┘
```

### 地形元素

| 图标 | 元素 | 效果 |
|------|------|------|
| ▓▓ | **实体墙** | 完全阻挡移动和子弹，不可破坏 |
| ░░ | **掩体/沙袋** | 可破坏（3 发子弹），阻挡子弹但可翻越 |
| 🌲 | **树林** | 阻挡视野，可穿过，子弹穿透但减速 |
| 🌿 | **草丛** | 躲藏时隐身，攻击/受伤后暴露 3 秒 |
| 🌊 | **水域** | 可进入，移速 -50%，无法使用技能 |
| 🔥 | **岩浆区** | 进入持续掉血，但可绕路包抄 |

### 建筑与结构

| 图标 | 元素 | 效果 |
|------|------|------|
| 🏠 | **房屋** | 可进入，有门窗可射击，提供掩护 |
| 🚪 | **门** | 可开关，关闭时阻挡视野和子弹 |
| 🏭 | **工厂** | 大型建筑，多层结构，内有道具 |
| ⚙️ | **机关** | 触发后激活陷阱（如落石、喷火） |

### 动态机关

| 图标 | 元素 | 效果 |
|------|------|------|
| 💣 | **爆炸桶** | 被攻击后爆炸，范围伤害 + 击退 |
| ═══ (桥梁) | **木桥** | 可破坏，断裂后下方是水域 |
| ═══ (铁轨) | **铁轨** | 每 30 秒有矿车经过，碰到必死 |
| ═══ (传送带) | **传送带** | 站上去会被推向一个方向 |
| 🚗 | **废弃车辆** | 高级掩体，可推动改变位置 |

### 环境事件（随机触发）

| 事件 | 触发条件 | 效果 |
|------|----------|------|
| ⛈️ 雷暴 | 游戏中期随机 | 视野降低，随机落雷造成范围伤害 |
| 🌫️ 浓雾 | 20% 概率出现 | 全场视野减半，持续 30 秒 |
| 📦 空投 | 每次缩圈时 | 随机位置掉落高级道具 |
| 💥 地震 | 最后 1 分钟 | 部分墙壁坍塌，开辟新路径 |

### 缩圈时间轴（4 分钟）

```
0:00 ────────── 1:00 ────────── 2:00 ────────── 3:00 ────────── 4:00
 │               │               │               │               │
游戏开始        第1次缩圈       第2次缩圈       第3次缩圈        决赛圈
全地图可用       缩至 70%        缩至 40%        缩至 15%        极小区域
 │               │               │               │
 └─ 📦 第1次空投  └─ 📦 第2次空投  └─ 💥 可能地震   └─ 最终决战
```

### 缩圈伤害递增

| 阶段 | 圈外伤害 |
|------|----------|
| 第 1 圈 | 3%/秒 |
| 第 2 圈 | 6%/秒 |
| 第 3 圈 | 10%/秒 |
| 决赛圈 | 15%/秒 |

---

## ⚔️ 战斗与武器系统

### 基础武器

| 武器 | 伤害 | 射速 | 射程 | 弹夹 | 特点 |
|------|------|------|------|------|------|
| 🔫 手枪 | 10 | 中等 | 中 | 12 | 初始武器，均衡 |
| 🔫 冲锋枪 | 7 | 极快 | 短 | 30 | 近距离扫射 |
| 🎯 步枪 | 18 | 慢 | 远 | 8 | 精准远程 |
| 💥 霰弹枪 | 25×5 | 极慢 | 极短 | 6 | 近身爆发 |

**武器获取规则**：
- 开局自带手枪
- 其他武器在地图上随机刷新
- 只能持有 1 把武器，捡新的替换旧的

### 伤害计算

```
最终伤害 = 基础伤害 × 距离衰减 × 爆头加成 × 护盾减免

距离衰减：
  - 有效射程内：100%
  - 超出射程：每 10% 距离 -15% 伤害

爆头加成：
  - 命中头部：×1.5 伤害

护盾/技能减免：
  - 重装举盾：×0.5
  - 磁力护盾：完全吸收 1 次
```

### 玩家状态

| 属性 | 数值 | 说明 |
|------|------|------|
| 生命值 | 100 (重装 130) | 归零即淘汰 |
| 弹药 | 按武器弹夹 | 自动换弹 2 秒 |
| 技能 CD | 基础 5 秒 / 道具一次性 | UI 显示冷却 |

### 击杀与淘汰

```
击杀玩家 ──▶ 掉落当前武器 + 未使用的道具技能
           │
           └──▶ 击杀者获得 +25 生命值恢复（上限 100）
```

---

## 🖥️ UI 与 HUD 设计

### 游戏内 HUD 布局

```
┌─────────────────────────────────────────────────────────────────┐
│  [存活: 5/8]              ⏱️ 2:35              [🌐 45ms]        │
│                                                                 │
│                         游戏画面区域                             │
│                                                                 │
│                           ┌─────┐                               │
│                           │  ⊕  │  ← 瞄准准星                   │
│                           └─────┘                               │
│                                                                 │
│  ┌──────────┐                                    ┌───────────┐  │
│  │ HP ████░░│                                    │ 🔫 24/30  │  │
│  │ 85/100   │                                    │    步枪   │  │
│  └──────────┘                                    └───────────┘  │
│                                                                 │
│  ┌────┐ ┌────┐          ┌─────────┐                            │
│  │ Q  │ │ E  │          │ 移动摇杆 │          ┌─────────┐      │
│  │冲刺│ │⚡15s│          │   ◯     │          │ 射击按钮 │      │
│  │CD:2│ │    │          └─────────┘          │   🔴    │      │
│  └────┘ └────┘                                └─────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

### HUD 元素说明

| 位置 | 元素 | 信息 |
|------|------|------|
| 左上 | 存活人数 | 当前剩余玩家 / 总人数 |
| 中上 | 倒计时 | 距离下次缩圈时间 |
| 右上 | 网络延迟 | 实时 ping 值，卡顿预警 |
| 左下 | 血条 | 当前生命值 / 最大值 |
| 右下 | 武器 | 当前弹药 / 弹夹容量 + 武器名 |
| 底部左 | 技能栏 | Q = 角色技能，E = 道具技能 |
| 底部中 | 虚拟摇杆 | 移动控制（触屏设备显示） |
| 底部右 | 射击按钮 | 点击/按住射击 |

### 小地图

```
┌─────────────┐
│  ·    ▲     │  ▲ = 自己
│      ◯      │  ◯ = 安全区
│  ·       ·  │  · = 队友/敌人（可见时）
│    ╳        │  ╳ = 击杀位置
│        ◯    │  阴影 = 缩圈区域
└─────────────┘
```

### 游戏结束界面

```
┌─────────────────────────────────────────┐
│           🏆 第 2 名                     │
│                                         │
│   击杀数：3    伤害量：450    存活：2:35  │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │ 排名  玩家      击杀  伤害       │   │
│   │ 🥇    Player1   5    680        │   │
│   │ 🥈    You       3    450        │   │
│   │ 🥉    Player3   2    320        │   │
│   │ 4     Player4   1    210        │   │
│   └─────────────────────────────────┘   │
│                                         │
│      [再来一局]      [返回大厅]          │
└─────────────────────────────────────────┘
```

---

## 🌐 网络同步与数据流

### 客户端-服务器通信模型

```
┌─────────────┐                          ┌─────────────┐
│   客户端A   │                          │   客户端B   │
│             │                          │             │
│  按下方向键  │                          │             │
│      │      │                          │             │
│      ▼      │                          │             │
│  本地预测   │──── 发送输入 ────▶┌──────┴──────┐      │
│  立即移动   │                  │             │      │
│             │                  │  Colyseus   │      │
│             │                  │   服务器    │      │
│             │                  │             │      │
│             │◀── 广播状态 ────│  验证+计算   │────▶│
│  校正位置   │                  │  权威状态   │ 更新位置│
│             │                  └─────────────┘      │
└─────────────┘                                       └─────────────┘
```

### 同步数据结构

```typescript
// 房间状态 (服务端权威)
RoomState {
  phase: "waiting" | "starting" | "playing" | "ended"
  countdown: number           // 倒计时秒数
  safeZone: { x, y, radius }  // 安全区
  nextZone: { x, y, radius }  // 下一个安全区
  items: Map<id, ItemState>   // 地图上的道具
  players: Map<id, PlayerState>
}

// 玩家状态
PlayerState {
  id: string
  name: string
  character: "assault" | "tank" | "ranger" | "medic"
  x, y: number                // 位置
  angle: number               // 朝向
  hp: number
  weapon: WeaponType
  skill: SkillState           // 道具技能
  isAlive: boolean
}
```

### 消息类型

| 方向 | 消息 | 内容 | 频率 |
|------|------|------|------|
| 客户端→服务器 | `input` | 方向、射击、技能 | 每帧 (60/秒) |
| 客户端→服务器 | `ping` | 时间戳 | 每秒 |
| 服务器→客户端 | `state` | 完整房间状态 | 20次/秒 |
| 服务器→客户端 | `hit` | 伤害事件 | 事件触发 |
| 服务器→客户端 | `kill` | 击杀事件 | 事件触发 |
| 服务器→客户端 | `zone` | 缩圈更新 | 缩圈时 |

### 延迟补偿策略

| 技术 | 作用 |
|------|------|
| **客户端预测** | 本地立即响应输入，不等服务器确认 |
| **服务端回滚** | 射击判定时，回滚到玩家开枪时的游戏状态 |
| **插值平滑** | 其他玩家位置平滑过渡，避免跳变 |
| **Ping 显示** | 让玩家了解网络状况 |

---

## 📁 项目目录结构

```
pixel-arena/
├── client/                     # 前端 (Phaser 3)
│   ├── public/
│   │   └── index.html
│   ├── src/
│   │   ├── main.ts             # 入口文件
│   │   ├── config.ts           # 游戏配置常量
│   │   │
│   │   ├── scenes/             # Phaser 场景
│   │   │   ├── BootScene.ts    # 资源预加载
│   │   │   ├── MenuScene.ts    # 主菜单 + 角色选择
│   │   │   ├── LobbyScene.ts   # 房间等待大厅
│   │   │   ├── GameScene.ts    # 核心游戏场景
│   │   │   └── ResultScene.ts  # 结算界面
│   │   │
│   │   ├── entities/           # 游戏实体
│   │   │   ├── Player.ts       # 玩家类
│   │   │   ├── Bullet.ts       # 子弹类
│   │   │   ├── Item.ts         # 道具类
│   │   │   └── Obstacle.ts     # 障碍物类
│   │   │
│   │   ├── ui/                 # UI 组件
│   │   │   ├── HUD.ts          # 游戏内 HUD
│   │   │   ├── Joystick.ts     # 虚拟摇杆
│   │   │   ├── HealthBar.ts    # 血条组件
│   │   │   └── MiniMap.ts      # 小地图
│   │   │
│   │   ├── network/            # 网络层
│   │   │   ├── Client.ts       # Colyseus 客户端封装
│   │   │   ├── StateSync.ts    # 状态同步处理
│   │   │   └── Interpolation.ts# 插值平滑
│   │   │
│   │   └── assets/             # 静态资源
│   │       ├── sprites/        # 角色、武器、道具精灵图
│   │       ├── maps/           # 地图瓦片
│   │       ├── audio/          # 音效
│   │       └── ui/             # UI 图片
│   │
│   ├── package.json
│   └── vite.config.ts          # Vite 构建配置
│
├── server/                     # 后端 (Colyseus)
│   ├── src/
│   │   ├── index.ts            # 服务器入口
│   │   ├── config.ts           # 服务器配置
│   │   │
│   │   ├── rooms/              # 游戏房间
│   │   │   ├── GameRoom.ts     # 主游戏房间逻辑
│   │   │   └── LobbyRoom.ts    # 大厅房间
│   │   │
│   │   ├── schemas/            # Colyseus 状态定义
│   │   │   ├── RoomState.ts    # 房间状态
│   │   │   ├── PlayerState.ts  # 玩家状态
│   │   │   └── ItemState.ts    # 道具状态
│   │   │
│   │   ├── game/               # 游戏逻辑
│   │   │   ├── GameLoop.ts     # 游戏主循环
│   │   │   ├── Physics.ts      # 碰撞检测
│   │   │   ├── Combat.ts       # 伤害计算
│   │   │   ├── SafeZone.ts     # 缩圈逻辑
│   │   │   └── ItemSpawner.ts  # 道具刷新
│   │   │
│   │   ├── characters/         # 角色定义
│   │   │   ├── Assault.ts
│   │   │   ├── Tank.ts
│   │   │   ├── Ranger.ts
│   │   │   └── Medic.ts
│   │   │
│   │   └── utils/              # 工具函数
│   │       ├── math.ts         # 数学计算
│   │       └── logger.ts       # 日志
│   │
│   ├── package.json
│   └── tsconfig.json
│
├── shared/                     # 共享代码
│   ├── constants.ts            # 游戏常量 (伤害值、速度等)
│   ├── types.ts                # TypeScript 类型定义
│   └── messages.ts             # 消息类型定义
│
├── package.json                # 根目录 (workspace)
├── README.md
└── .gitignore
```

### 技术栈版本

| 依赖 | 版本 | 用途 |
|------|------|------|
| Phaser | 3.70+ | 游戏引擎 |
| Colyseus | 0.15+ | 多人服务器 |
| TypeScript | 5.0+ | 类型安全 |
| Vite | 5.0+ | 前端构建 |
| Node.js | 20+ LTS | 服务器运行时 |

---

## 🛣️ 开发路线图

### 阶段 1：基础框架

| 任务 | 产出 |
|------|------|
| 初始化项目结构 | client/server/shared 目录 |
| Phaser 场景搭建 | Boot → Menu → Game 场景切换 |
| 基础渲染 | 地图瓦片 + 玩家精灵显示 |
| 本地移动控制 | 键盘/虚拟摇杆移动角色 |

**里程碑**：单机可以在地图上移动的角色

---

### 阶段 2：核心玩法（单机）

| 任务 | 产出 |
|------|------|
| 射击系统 | 子弹发射、碰撞检测 |
| 武器系统 | 4 种武器切换、拾取 |
| 角色技能 | 4 个角色基础技能 |
| 道具系统 | 道具刷新、拾取、效果 |
| 伤害系统 | 血量、伤害计算、死亡 |
| 缩圈机制 | 安全区显示、圈外伤害 |

**里程碑**：单机可玩的完整游戏循环（vs AI 或靶子）

---

### 阶段 3：多人联机

| 任务 | 产出 |
|------|------|
| Colyseus 服务器 | 房间创建、加入、销毁 |
| 状态同步 | 玩家位置、血量同步 |
| 匹配大厅 | 等待界面、开始倒计时 |
| 战斗同步 | 射击、伤害、击杀事件 |
| 延迟优化 | 客户端预测、插值平滑 |

**里程碑**：2+ 玩家可以联机对战

---

### 阶段 4：完善打磨

| 任务 | 产出 |
|------|------|
| 动态机关 | 爆炸桶、传送带、矿车 |
| 环境事件 | 雷暴、浓雾、空投 |
| 音效 | 射击、爆炸、技能音效 |
| UI 完善 | HUD、小地图、结算界面 |
| 本地存储 | 昵称、战绩保存 |
| Bug 修复 | 测试 + 修复 |

**里程碑**：功能完整、体验流畅的游戏

---

### 阶段 5：部署上线

| 任务 | 产出 |
|------|------|
| 服务器部署 | 云服务器 (推荐: Railway/Render) |
| 静态托管 | 前端部署 (推荐: Vercel/Netlify) |
| 域名配置 | HTTPS + WebSocket 支持 |
| 性能监控 | 日志 + 错误追踪 |

**里程碑**：公开可访问的游戏

---

## 📚 参考资源

- [Phaser 3 官方文档](https://phaser.io/docs)
- [Colyseus 官方文档](https://docs.colyseus.io/)
- [Medium - Multiplayer Game Architecture](https://medium.com)
- [Icon Era - Netcode Best Practices](https://icon-era.com)
- [Uverse Digital - Game Server Architecture](https://uversedigital.com)
